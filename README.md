# Dataset Transformation
Convert an Arabic function-calling dataset into Mobile Actions / FunctionGemma chat format.

## Purpose
- Standardize Arabic user queries and tool calls for training FunctionGemma-style models.
- Produce deterministic JSONL suitable for tokenizer `apply_chat_template`.
- Auto-generate a function schema registry from observed `function_name` and `arguments`.

## Repository Layout
- `scripts/convert_dataset.py` — load HF dataset, write raw copy, convert to chat format, build `schemas/registry.json`.
- `scripts/validate_with_tokenizer.py` — run `tokenizer.apply_chat_template` from `google/function-gemma-2b` over every record.
- `raw/` — raw dataset snapshot (`dataset.jsonl`).
- `output/` — converted dataset (`dataset_functiongemma.jsonl`).
- `schemas/` — auto-generated function registry.

## Dataset Format (output)
Case 1 — Tool Required
```json
{"messages": [
  {"role": "user", "content": "<arabic query>"},
  {"role": "assistant", "tool_calls": [
    {"name": "<function_name>", "arguments": { "key": "value" }}
  ]}
]}
```
Case 2 — No Tool Required
```json
{"messages": [
  {"role": "user", "content": "<arabic query>"},
  {"role": "assistant", "content": "<arabic answer>"}
]}
```

### Example (synthetic)
```json
{"messages":[
  {"role":"user","content":"ما حالة الطقس غدًا في الرياض؟"},
  {"role":"assistant","tool_calls":[{"name":"get_weather","arguments":{"city":"الرياض","day":"غدًا"}}]}
]}
{"messages":[
  {"role":"user","content":"ما هي فوائد شرب الماء؟"},
  {"role":"assistant","content":"يساعد شرب الماء على الترطيب وتحسين وظائف الجسم."}
]}
```

## Prerequisites
- Python 3.10+
- Packages: `pip install datasets transformers tqdm`
- Access to `google/function-gemma-2b` (set `HUGGINGFACE_TOKEN` if the model is gated).

## Run Conversion
```bash
python scripts/convert_dataset.py \
  --dataset <hf_dataset_name_or_path> \
  --split train \
  --raw-path raw/dataset.jsonl \
  --output-path output/dataset_functiongemma.jsonl \
  --registry-path schemas/registry.json
```
Optional: `--max-rows 500` to dry-run on a subset.

## Run Validation
```bash
python scripts/validate_with_tokenizer.py \
  --dataset-path output/dataset_functiongemma.jsonl \
  --model google/function-gemma-2b
```
- Fails fast if any record cannot be rendered by `apply_chat_template`.
- Use `--fail-fast` to stop on first issue or `--max-records` for spot checks.

## Team Contribution Rules
- Keep changes small and reversible; prefer additive diffs.
- Do not overwrite raw or output files generated by others without coordination.
- Ensure conversion stays deterministic (no randomized shuffling).
- Add tests or validation runs before proposing changes; share command outputs.
- Document new parameters or behaviors in this README.
